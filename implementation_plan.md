# TubeMix B2B 構想メモ（壁打ち）

YouTube の DJ Mix 動画を「対戦相手」に見立てて、手元の DDJ-FLX4 で B2B セッションを行うための技術検討。

## コンセプト
- **世界のトップ DJ と B2B**: YouTube で公開されている Boiler Room などの動画に合わせて、自分の曲を繋ぐ。
- **耳コピ・ピッチマッチング特化**: YouTube には波形表示がないため、完全に「耳」だけでピッチを合わせる練習台として活用。
- **DDJ-FLX4 連携**: ブラウザ (Web MIDI API) でコントローラーを認識し、ブラウザ上の Deck B を操作。

## 技術的検討事項

### 1. オーディオ・ルーティング (最大の難所)
- **課題**: DJ には「マスター出力」と「モニター（ヘッドホン）出力」の 2 系統が必要。
- **現状**: ブラウザの標準的な音声出力は 1 系統のみ。YouTube の音声とブラウザで再生する Deck B の音声をどう分けるか？
- **解決策案**: 
  - DDJ-FLX4 は内蔵オーディオインターフェースを搭載しており、マスターとヘッドホンの別出力が可能。
  - `Web Audio API` を使えば、ブラウザ内で複数の出力先（マルチチャンネル出力）を指定できる。

### 2. YouTube API の制約
- **課題**: 前述の通り、YouTube の再生速度はステップ刻み（0.25 単位など）。
- **戦略**: 
  - **YouTube 側**: 常に 1.0 倍速（あるいは Mix 動画のピッチに合わせて固定）。
  - **ユーザー側 (Deck B)**: こちらの再生速度を DDJ-FLX4 のピッチフェーダーで「YouTube 側の BPM に追従」させる。
  - **Sync ボタンなし**: 耳で合わせるのが目的なので、あえて Sync ボタンを実装しない、あるいは機能させない。

### 3. DDJ-FLX4 の MIDI マッピング
- FLX4 は標準的な MIDI 信号を送出するため、Web MIDI API で受信可能。
- ジョグホイールのスクラッチやピッチフェーダー、縦フェーダー、EQ などのマッピングを定義すれば、ブラウザ上のソフトを実機感覚で操作できる。

## 議論したいポイント
1. **モニターの必要性**: ブラウザだけで完結させる場合、ヘッドホンで Deck B の「待ち」の音を聞く必要があるが、ユーザーはどのような機材構成を想定しているか？（FLX4 から直接音を出す想定か？）
2. **UI の方向性**: YouTube 動画を主役に据えつつ、自分の操作状態（BPM、ピッチ、EQ）をどう表示するか。
3. **楽曲の調達**: Deck B で流す曲は、ローカルファイルの読み込みか、あるいは別の YouTube 動画を 2 つ並べるスタイルか？

## 波形表示と視覚情報の制御 (NEW)

### 1. ローカル音源 (Deck B) の波形
- **実現方法**: `Web Audio API` でファイルをデコードし、音量を Canvas 等で描画。
- **機能**: 全体の構成確認用と、スクラッチ用の拡大波形の 2 種類を表示。

### 2. YouTube (Deck A) の波形
- **技術的課題**: YouTube 動画の音声データはブラウザのセキュリティ制限 (CORS) により直接読み取ることができません。そのため、標準的な方法では波形を生成できません。
- **対策案**: 
    - **案A (解析情報)**: 大まかな音量の変化をリアルタイムで波形っぽく動かす「ビジュアライザー」で代用。
    - **案B (サーバーサイド)**: サーバー側で事前に波形データを抽出し、それを JSON 等でクライアントに送る（YouTube URL ごとにデータを保持する必要がある）。

### 3. 表示・非表示（Blind Mode）
- **コンセプト**: 耳を鍛えるために、ボタン一つで「すべての波形を隠す」機能を搭載。
- **練習フロー**: 波形を見て大まかな BPM を推測 -> 波形を隠して耳だけでマッチング -> 最後に見開いて答え合わせ。

## システム構成案 (B2B 操作フロー)
```mermaid
graph TD
    A[YouTube Mix (Deck A)] -->|Audio| B(Master Output)
    C[Local MP3 / YouTube (Deck B)] -->|Audio| B
    C -->|CUE Audio| D(Headphones via DDJ-FLX4)
    
    E[DDJ-FLX4] -->|MIDI| F{Browser App}
    F -->|Control| A
    F -->|Control| C
```

## UI レイアウト案
- **上部**: YouTube プレイヤー (Deck A) - 視覚的に DJ の動きが見えるように大きく配置。
- **中央**: オーディオ情報 (Deck B) - 現在の BPM、ピッチ偏差 (+/- %)、Waveform (ローカル音源の場合)。
- **下部**: ミキサー状態 - EQ (Low/Mid/Hi)、Filter、Crossfader の位置をリアルタイム表示。
- **背景**: 動画の雰囲気に合わせたアンビエントなライティング演出。

## 詳細技術設計 (DDJ-FLX4 連携)

### 1. MIDI マッピング案 (FLX4 -> Browser)
FLX4 から送出される標準的な MIDI 信号を以下のようにマッピングします：
- **JOG Wheel**: ブラウザ側 Deck B のスクラッチ・ピッチベンド。
- **Pitch Fader**: Deck B の再生速度調整 (Web Audio API の `playbackRate`)。
- **EQ / Filter**: Deck B の周波数フィルタリング (BiquadFilterNode)。
- **CUE Button**: ヘッドホン出力へのルーティング切り替え。
- **Play/Pause**: デッキの再生・停止。

### 2. オーディオ出力のルーティング
ブラウザの `AudioContext.destination` を DDJ-FLX4 のマルチチャンネル出力にマッピングします：
- **Ch 1-2 (Master)**: YouTube (Deck A) + Deck B (Fader open)
- **Ch 3-4 (Headphones)**: Deck B (CUE enabled)

### 3. ステップアップ・ガイド (UX)
耳で合わせるのが難しい初心者向けに、以下のような「トレーニングモード」を構想：
- **BPM 推定器**: Deck A (YouTube) の BPM をタップや解析で大まかに取得。
- **ビジュアルエイド**: ピッチが合っているかどうかのヒントを、波形ではなく「色の変化」などで抽象的に提示（完全に答えは見せない）。

## 検討中：サービス名案
- **TubeMix B2B**: 直感的で分かりやすい。
- **F2F (Fade to Face)**: YouTube の DJ と対峙するニュアンス。
- **EarTrain DJ**: 練習ツールとしての側面を強調。

## クリエイティブ・アイデア (将来の拡張)

### 1. Ghost Session (自分の足跡を振り返る)
- 自分の操作（フェーダー、EQ、選曲）を MIDI ログとして記録し、後で YouTube 動画と一緒に「答え合わせ」ができる。
- 「この時点でピッチが 0.5% ズレていた」等のフィードバック。

### 2. Ambient Visualizer
- 再生中の YouTube 動画の主要な色を抽出し、画面全体をその色のライティングで包む。
- 部屋を暗くして使うと、まさに Boiler Room で回しているような没入感。

### 3. B2B Battle Mode (対戦)
- YouTube の DJ が曲を繋ぎ終わった直後に、自分がどれだけスムーズに繋げられたかを「AI が採点」あるいは「波形の後出し公開」で自己評価。

## まとめ：このサービスの「売り」
- **「機材さえあれば、世界中の DJ Mix が君の練習台になる」**
- 波形に頼らない、本質的な DJ スキル（耳と直感）を鍛えるための唯一無二のプラットフォーム。
